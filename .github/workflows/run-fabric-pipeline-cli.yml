name: Run Fabric Pipeline (using CLI) 

on:
  schedule:
    - cron: '0 6 * * *' # 
  workflow_dispatch:
    inputs:
      pipeline_name:
        description: 'Pipeline name'
        required: true
        type: string
        default: 'pp-int-run-w-logging'
      workspace_name:
        description: 'Workspace name'
        required: true
        type: string
        default: 'int-prod-processing'

env:
  PYTHON_VERSION: '3.12'
  FABRIC_CLI_VERSION: '1.2.0'

jobs:
  run-pipeline:
    runs-on: windows-latest

    env:
      AZURE_CLIENT_ID: ${{ secrets.SPN_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.SPN_CLIENT_SECRET }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Fabric CLI
        run: pip install ms-fabric-cli==${{ env.FABRIC_CLI_VERSION }}

      - name: Authenticate to Fabric
        run: fab auth login -u ${{ env.AZURE_CLIENT_ID }} -p ${{ env.AZURE_CLIENT_SECRET }} --tenant ${{ env.AZURE_TENANT_ID }}

      - name: Configure Azure Context
        run: |
          fab config set default_az_subscription_id ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          fab config set default_az_resource_group ${{ vars.RESOURCE_GROUP }}

      - name: Resume Capacity
        run: fab start .capacities/${{ vars.CAPACITY_NAME }}.Capacity -f

      - name: Run Pipeline
        run: fab job run "${{ inputs.workspace_name || 'int-prod-processing' }}.Workspace/${{ inputs.pipeline_name || 'pp-int-run-w-logging' }}.DataPipeline" --timeout 7200

      - name: Suspend Capacity
        if: always()
        run: fab stop .capacities/${{ vars.CAPACITY_NAME }}.Capacity -f