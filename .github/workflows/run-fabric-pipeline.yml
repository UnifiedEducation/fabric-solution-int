name: Run Fabric Pipeline with Capacity Management

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      pipeline_id:
        description: 'Pipeline Item ID to execute (leave empty to use default)'
        required: false
        type: string

env:
  # Polling configuration
  CAPACITY_POLL_INTERVAL: 30      # seconds between capacity status checks
  CAPACITY_MAX_WAIT: 600          # max seconds to wait for capacity resume (10 min)
  PIPELINE_POLL_INTERVAL: 60      # seconds between pipeline status checks
  PIPELINE_MAX_WAIT: 7200         # max seconds to wait for pipeline completion (2 hours)

jobs:
  run-fabric-pipeline:
    runs-on: ubuntu-latest

    steps:
      # ============================================
      # SETUP PHASE
      # ============================================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Fabric CLI
        run: |
          python -m pip install --upgrade pip
          pip install ms-fabric-cli==1.2.0

      - name: Authenticate to Fabric
        run: |
          fab auth login -u ${{ secrets.SPN_CLIENT_ID }} -p ${{ secrets.SPN_CLIENT_SECRET }} --tenant ${{ secrets.AZURE_TENANT_ID }}

      - name: Set Pipeline ID
        id: set-pipeline-id
        run: |
          if [ -n "${{ inputs.pipeline_id }}" ]; then
            echo "PIPELINE_ID=${{ inputs.pipeline_id }}" >> $GITHUB_OUTPUT
            echo "Using input pipeline ID: ${{ inputs.pipeline_id }}"
          else
            echo "PIPELINE_ID=${{ vars.PIPELINE_ITEM_ID }}" >> $GITHUB_OUTPUT
            echo "Using default pipeline ID: ${{ vars.PIPELINE_ITEM_ID }}"
          fi

      # ============================================
      # RESUME CAPACITY PHASE
      # ============================================
      - name: Resume Fabric Capacity
        id: resume-capacity
        run: |
          echo "Resuming Fabric Capacity: ${{ vars.CAPACITY_NAME }}"

          ENDPOINT="subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ vars.RESOURCE_GROUP }}/providers/Microsoft.Fabric/capacities/${{ vars.CAPACITY_NAME }}/resume?api-version=2023-11-01"

          # Execute resume API call
          RESPONSE=$(fab api -A azure -X post "$ENDPOINT" 2>&1) || true

          echo "Resume response: $RESPONSE"

          # Check if successful (200 immediate or 202 async)
          if echo "$RESPONSE" | grep -qE "200|202|provisioningState|error.*AlreadyStarted"; then
            echo "Capacity resume initiated successfully"
            echo "RESUME_INITIATED=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::Unexpected response from resume API: $RESPONSE"
            echo "RESUME_INITIATED=true" >> $GITHUB_OUTPUT
          fi

      - name: Wait for Capacity to be Ready
        id: wait-capacity
        run: |
          echo "Waiting for capacity to become active..."

          ENDPOINT="subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ vars.RESOURCE_GROUP }}/providers/Microsoft.Fabric/capacities/${{ vars.CAPACITY_NAME }}?api-version=2023-11-01"

          START_TIME=$(date +%s)
          READY=false

          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))

            if [ $ELAPSED -ge ${{ env.CAPACITY_MAX_WAIT }} ]; then
              echo "::error::Timeout waiting for capacity to resume after ${ELAPSED} seconds"
              exit 1
            fi

            # Get capacity status
            STATUS_RESPONSE=$(fab api -A azure -X get "$ENDPOINT" 2>&1) || true

            # Check for Active state
            if echo "$STATUS_RESPONSE" | grep -q '"state".*"Active"'; then
              echo "Capacity is now Active!"
              READY=true
              break
            fi

            echo "Capacity not ready yet. Elapsed: ${ELAPSED}s. Waiting ${{ env.CAPACITY_POLL_INTERVAL }}s..."
            sleep ${{ env.CAPACITY_POLL_INTERVAL }}
          done

          if [ "$READY" = "true" ]; then
            echo "CAPACITY_READY=true" >> $GITHUB_OUTPUT
          else
            echo "CAPACITY_READY=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      # ============================================
      # EXECUTE PIPELINE PHASE
      # ============================================
      - name: Run Fabric Pipeline
        id: run-pipeline
        run: |
          echo "Starting pipeline execution..."

          PIPELINE_ID="${{ steps.set-pipeline-id.outputs.PIPELINE_ID }}"
          WORKSPACE_ID="${{ vars.WORKSPACE_ID }}"

          ENDPOINT="workspaces/${WORKSPACE_ID}/items/${PIPELINE_ID}/jobs/instances?jobType=Pipeline"

          echo "Calling: $ENDPOINT"

          # Execute pipeline
          RESPONSE=$(fab api -X post "$ENDPOINT" 2>&1) || true

          echo "Pipeline trigger response: $RESPONSE"

          # Extract job instance ID from response
          # The response should contain the job instance ID
          JOB_INSTANCE_ID=$(echo "$RESPONSE" | grep -oP '"id"\s*:\s*"\K[a-f0-9-]+' | head -1)

          if [ -n "$JOB_INSTANCE_ID" ]; then
            echo "Job Instance ID: $JOB_INSTANCE_ID"
            echo "JOB_INSTANCE_ID=$JOB_INSTANCE_ID" >> $GITHUB_OUTPUT
            echo "PIPELINE_STARTED=true" >> $GITHUB_OUTPUT
          else
            echo "::error::Failed to extract job instance ID from response"
            echo "Response was: $RESPONSE"
            exit 1
          fi

      - name: Wait for Pipeline Completion
        id: wait-pipeline
        run: |
          echo "Monitoring pipeline execution..."

          JOB_INSTANCE_ID="${{ steps.run-pipeline.outputs.JOB_INSTANCE_ID }}"
          PIPELINE_ID="${{ steps.set-pipeline-id.outputs.PIPELINE_ID }}"
          WORKSPACE_ID="${{ vars.WORKSPACE_ID }}"

          ENDPOINT="workspaces/${WORKSPACE_ID}/items/${PIPELINE_ID}/jobs/instances/${JOB_INSTANCE_ID}"

          START_TIME=$(date +%s)
          FINAL_STATUS=""

          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))

            if [ $ELAPSED -ge ${{ env.PIPELINE_MAX_WAIT }} ]; then
              echo "::error::Timeout waiting for pipeline completion after ${ELAPSED} seconds"
              FINAL_STATUS="Timeout"
              break
            fi

            # Get job status
            STATUS_RESPONSE=$(fab api -X get "$ENDPOINT" 2>&1) || true

            # Extract status from response
            STATUS=$(echo "$STATUS_RESPONSE" | grep -oP '"status"\s*:\s*"\K[^"]+' | head -1)

            echo "Current status: $STATUS (Elapsed: ${ELAPSED}s)"

            case "$STATUS" in
              "Completed")
                echo "Pipeline completed successfully!"
                FINAL_STATUS="Completed"
                break
                ;;
              "Failed")
                echo "::error::Pipeline execution failed!"
                FAILURE_REASON=$(echo "$STATUS_RESPONSE" | grep -oP '"failureReason"\s*:\s*"\K[^"]+' | head -1)
                if [ -n "$FAILURE_REASON" ]; then
                  echo "Failure reason: $FAILURE_REASON"
                fi
                FINAL_STATUS="Failed"
                break
                ;;
              "Cancelled")
                echo "::error::Pipeline was cancelled!"
                FINAL_STATUS="Cancelled"
                break
                ;;
              "Deduped")
                echo "::warning::Pipeline was deduped (skipped due to existing run)"
                FINAL_STATUS="Deduped"
                break
                ;;
              "NotStarted"|"InProgress")
                echo "Pipeline still running. Waiting ${{ env.PIPELINE_POLL_INTERVAL }}s..."
                sleep ${{ env.PIPELINE_POLL_INTERVAL }}
                ;;
              *)
                echo "::warning::Unknown status: $STATUS"
                sleep ${{ env.PIPELINE_POLL_INTERVAL }}
                ;;
            esac
          done

          echo "FINAL_STATUS=$FINAL_STATUS" >> $GITHUB_OUTPUT

          if [ "$FINAL_STATUS" != "Completed" ] && [ "$FINAL_STATUS" != "Deduped" ]; then
            echo "::error::Pipeline did not complete successfully. Final status: $FINAL_STATUS"
            exit 1
          fi

      # ============================================
      # CLEANUP PHASE (ALWAYS RUNS)
      # ============================================
      - name: Suspend Fabric Capacity
        if: always()
        run: |
          echo "Suspending Fabric Capacity to avoid costs..."

          # Re-authenticate in case token expired during long pipeline run
          fab auth login -u ${{ secrets.SPN_CLIENT_ID }} -p ${{ secrets.SPN_CLIENT_SECRET }} --tenant ${{ secrets.AZURE_TENANT_ID }} || true

          ENDPOINT="subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ vars.RESOURCE_GROUP }}/providers/Microsoft.Fabric/capacities/${{ vars.CAPACITY_NAME }}/suspend?api-version=2023-11-01"

          # Execute suspend API call
          RESPONSE=$(fab api -A azure -X post "$ENDPOINT" 2>&1) || true

          echo "Suspend response: $RESPONSE"

          # Log result but don't fail the workflow if suspend fails
          if echo "$RESPONSE" | grep -qE "200|202"; then
            echo "Capacity suspend initiated successfully"
          else
            echo "::warning::Suspend may have encountered an issue: $RESPONSE"
          fi

      - name: Workflow Summary
        if: always()
        run: |
          echo "## Fabric Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Capacity Resume | ${{ steps.resume-capacity.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Capacity Ready | ${{ steps.wait-capacity.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pipeline Trigger | ${{ steps.run-pipeline.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pipeline Completion | ${{ steps.wait-pipeline.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Pipeline ID:** ${{ steps.set-pipeline-id.outputs.PIPELINE_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Job Instance ID:** ${{ steps.run-pipeline.outputs.JOB_INSTANCE_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Final Status:** ${{ steps.wait-pipeline.outputs.FINAL_STATUS }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Capacity:** ${{ vars.CAPACITY_NAME }}" >> $GITHUB_STEP_SUMMARY
